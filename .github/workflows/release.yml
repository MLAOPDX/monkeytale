# For more information see:
# https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions
# https://github.community/t/how-do-i-specify-job-dependency-running-in-another-workflow/16482

name: Monkeytale Continuous Integration
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  Build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Check-out
        uses: actions/checkout@v2
      - name: Install PDM
        uses: pdm-project/setup-pdm@main
        with:
          python-version: "3.10" # Same as actions/setup-python
          architecture: x64 # Same as actions/setup-python
          # version: 1.4.0 # The version of PDM to install. Leave empty to use latest from PyPI
          prerelease: false # Allow prereleases
          enable-pep582: true # Enable PEP 582 globally
      - name: Install application & dependencies
        run: |
          pdm --version
          pdm install -G test
      - name: Unit test application
        run: |
          pdm run pytest --version
          pdm run pytest -v ./tests
      - name: Source code security analysis
        run: |
          pdm run bandit --version
          pdm run bandit --recursive --skip B101 -x ./tests -x ./__pypackages__ .

  DeployToTestPyPI:
    needs: [Build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, 'chore(test_release)')

    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      # Set environment variables for Python Semantic Release to pick-up
      REPOSITORY_USERNAME: __token__
      REPOSITORY_PASSWORD: ${{ secrets.TESTPYPI_TOKEN }}

    steps:
      - name: Check-out with history
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Pull history for semantic versioning from commit messages
      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
      - name: Install Python Semantic Release
        run: |
          pip install python-semantic-release
          git config user.name semantic-release
          git config user.email semantic-release@dwlib.com
      - name: Publish application to test.pypi.org
        run: |
          semantic-release publish -D repository=testpypi

  DeployToPyPI:
    needs: [Build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, 'chore(release)')

    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      # Set environment variables for Python Semantic Release to pick-up
      REPOSITORY_USERNAME: __token__
      REPOSITORY_PASSWORD: ${{ secrets.PYPI_TOKEN }}

    steps:
      - name: Check-out with history
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Pull history for semantic versioning from commit messages
      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
      - name: Install Python Semantic Release
        run: |
          pip install python-semantic-release
          git config user.name semantic-release
          git config user.email semantic-release@dwlib.com
      - name: Publish application to pypi.org
        run: |
          semantic-release publish -D repository=pypi
